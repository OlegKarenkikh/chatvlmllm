# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–®–ò–ë–û–ö –û–§–ò–¶–ò–ê–õ–¨–ù–´–• –ü–†–û–ú–ü–¢–û–í –ü–†–ò–ú–ï–ù–ï–ù–´

## üö® –ü—Ä–æ–±–ª–µ–º—ã –∏–∑ –ª–æ–≥–æ–≤

–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –≤—ã—è–≤–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤:

### 1. **CUDA device-side assert triggered** 
- **–ß–∞—Å—Ç–æ—Ç–∞:** –í—ã—Å–æ–∫–∞—è - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- **–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
- **–ú–æ–¥–µ–ª–∏:** qwen_vl_2b, dots_ocr
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤

### 2. **video_processor NoneType error**
- **–ß–∞—Å—Ç–æ—Ç–∞:** –í—ã—Å–æ–∫–∞—è - –ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è  
- **–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- **–ú–æ–¥–µ–ª–∏:** dots_ocr
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ dots.ocr –º–æ–¥–µ–ª–∏

### 3. **FlashAttention2 not installed**
- **–ß–∞—Å—Ç–æ—Ç–∞:** –°—Ä–µ–¥–Ω—è—è
- **–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–∏–π - fallback –Ω–∞ eager attention
- **–ú–æ–¥–µ–ª–∏:** qwen3_vl_2b, qwen_vl_2b

### 4. **load_in_8bit error**
- **–ß–∞—Å—Ç–æ—Ç–∞:** –°—Ä–µ–¥–Ω—è—è
- **–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–∏–π - –±–ª–æ–∫–∏—Ä—É–µ—Ç 8bit –∑–∞–≥—Ä—É–∑–∫—É
- **–ú–æ–¥–µ–ª–∏:** qwen3_vl_2b, dots_ocr

## üîß –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CUDA –æ—à–∏–±–æ–∫**

**–í –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö:**
```python
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ GPU –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
if torch.cuda.is_available():
    torch.cuda.empty_cache()
    torch.cuda.synchronize()

# –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
gc.collect()

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –º–æ–¥–µ–ª–µ–π
try:
    from models.model_loader import ModelLoader
    ModelLoader.unload_all_models()
except:
    pass
```

**–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CUDA –æ—à–∏–±–æ–∫:**
```python
except RuntimeError as cuda_error:
    if "CUDA error" in str(cuda_error) or "device-side assert" in str(cuda_error):
        st.error("‚ùå –û—à–∏–±–∫–∞ GPU. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.")
        st.info("üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ vLLM —Ä–µ–∂–∏–º –¥–ª—è –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã.")
        response = f"‚ùå –û—à–∏–±–∫–∞ GPU: {str(cuda_error)}"
```

### 2. **Fallback –ª–æ–≥–∏–∫–∞ –¥–ª—è dots.ocr**

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Qwen3-VL:**
```python
# –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å dots.ocr
try:
    result = adapter.process_image(image, official_prompt, "rednote-hilab/dots.ocr")
except Exception as dots_error:
    st.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ dots.ocr: {dots_error}")
    st.info("üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ Qwen3-VL –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
    # Fallback –Ω–∞ Qwen3-VL
    try:
        result = adapter.process_image(image, official_prompt, "Qwen/Qwen3-VL-2B-Instruct")
        if result and result["success"]:
            result["text"] += "\n\n*‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —á–µ—Ä–µ–∑ Qwen3-VL (fallback)*"
    except Exception as fallback_error:
        st.error(f"‚ùå –û—à–∏–±–∫–∞ fallback –º–æ–¥–µ–ª–∏: {fallback_error}")
        result = {"success": False, "text": "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"}
```

### 3. **–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ video_processor –æ—à–∏–±–æ–∫**

```python
except Exception as model_error:
    if "video_processor" in str(model_error) or "NoneType" in str(model_error):
        st.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ dots.ocr. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Qwen3-VL.")
        response = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ dots.ocr"
    else:
        response = f"‚ùå –û—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏: {str(model_error)}"
```

### 4. **–£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**

**–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ GPU. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ vLLM —Ä–µ–∂–∏–º.
- ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ dots.ocr. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Qwen3-VL –¥–ª—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á.
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ vLLM —Ä–µ–∂–∏–º –¥–ª—è –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

### 5. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏**

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ–±–∞ —Ä–µ–∂–∏–º–∞ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏ –æ–±—ã—á–Ω—ã–π —á–∞—Ç):**
```python
import torch
import gc

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ GPU –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
if torch.cuda.is_available():
    torch.cuda.empty_cache()
    torch.cuda.synchronize()

# –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
gc.collect()
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è:

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ CUDA –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
2. **Fallback –ª–æ–≥–∏–∫–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
3. **–û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏:** –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ GPU –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:** –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
5. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** Graceful degradation –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∫—Ä–∞—Ö–∞

### üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

- **–ú–µ–Ω—å—à–µ CUDA –æ—à–∏–±–æ–∫** –±–ª–∞–≥–æ–¥–∞—Ä—è –æ—á–∏—Å—Ç–∫–µ –ø–∞–º—è—Ç–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** –Ω–∞ —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏
- **–õ—É—á—à–∏–π UX** —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö
- **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é vLLM —Ä–µ–∂–∏–º–∞

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã —Å dots.ocr:**
   - üî§ –ü—Ä–æ—Å—Ç–æ–µ OCR
   - üìã –î–µ—Ç–∞–ª—å–Ω–æ–µ OCR  
   - üèóÔ∏è –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - üìä –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
   - üìÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - CUDA –æ—à–∏–±–∫–∏ ‚Üí –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - dots.ocr –æ—à–∏–±–∫–∏ ‚Üí –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Qwen3-VL
   - –û–±—â–∏–µ –æ—à–∏–±–∫–∏ ‚Üí –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

3. **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**
   - vLLM —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
   - Transformers —Ä–µ–∂–∏–º (—Å fallback)

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –≤ Streamlit –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã** –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
3. **–£–±–µ–¥–∏—Ç—å—Å—è –≤ —Ä–∞–±–æ—Ç–µ fallback –ª–æ–≥–∏–∫–∏**
4. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
5. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

## üìù –§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´

- **`app.py`** - –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- **`fix_official_prompts_errors.py`** - –°–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- **`official_prompts_error_fixes.json`** - –û—Ç—á–µ—Ç –æ–± –æ—à–∏–±–∫–∞—Ö
- **`OFFICIAL_PROMPTS_ERROR_FIXES_APPLIED.md`** - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú

### –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ vLLM —Ä–µ–∂–∏–º** - –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π
2. **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö dots.ocr** - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ Qwen3-VL
3. **–ü—Ä–∏ CUDA –æ—à–∏–±–∫–∞—Ö** - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. **–î–ª—è OCR –∑–∞–¥–∞—á** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
5. **–î–ª—è —á–∞—Ç–∞ –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö** - –≤—ã–±–∏—Ä–∞–π—Ç–µ Qwen3-VL

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** üöÄ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ  
**–î–∞—Ç–∞:** 24.01.2026 22:45:00