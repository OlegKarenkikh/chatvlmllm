#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏ –≤ vLLM
"""

import time
from PIL import Image
import json
from datetime import datetime

def test_vllm_adapter_improvements():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π vLLM –∞–¥–∞–ø—Ç–µ—Ä–∞"""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô vLLM")
    print("=" * 50)
    
    try:
        from vllm_streamlit_adapter import VLLMStreamlitAdapter
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞
        adapter = VLLMStreamlitAdapter()
        
        # –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —Å –ª–∏–º–∏—Ç–∞–º–∏
        print("1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π...")
        models = adapter.get_available_models()
        
        if models:
            print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π: {len(models)}")
            for model in models:
                max_tokens = adapter.get_model_max_tokens(model)
                print(f"   üìä {model}: –º–∞–∫—Å–∏–º—É–º {max_tokens} —Ç–æ–∫–µ–Ω–æ–≤")
        else:
            print("   ‚ùå –ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return False
        
        # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏
        print("\n2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞...")
        status = adapter.get_server_status()
        
        if status.get("status") == "healthy":
            print("   ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–¥–æ—Ä–æ–≤")
            print(f"   üìä –ú–æ–¥–µ–ª–∏: {status.get('models', 0)}")
            
            model_limits = status.get('model_limits', {})
            if model_limits:
                print("   üìè –õ–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤:")
                for model, limit in model_limits.items():
                    print(f"      ‚Ä¢ {model}: {limit} —Ç–æ–∫–µ–Ω–æ–≤")
            else:
                print("   ‚ö†Ô∏è –õ–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã")
        else:
            print(f"   ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: {status}")
            return False
        
        # –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
        print("\n3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –ª–∏–º–∏—Ç–∞–º–∏...")
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        test_image = Image.new('RGB', (100, 100), color='blue')
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å –∏ –µ—ë –ª–∏–º–∏—Ç
        test_model = models[0]
        model_limit = adapter.get_model_max_tokens(test_model)
        
        print(f"   ü§ñ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å: {test_model}")
        print(f"   üìè –õ–∏–º–∏—Ç –º–æ–¥–µ–ª–∏: {model_limit} —Ç–æ–∫–µ–Ω–æ–≤")
        
        # –¢–µ—Å—Ç —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–∫–µ–Ω–æ–≤
        print(f"   üß™ –¢–µ—Å—Ç —Å {model_limit} —Ç–æ–∫–µ–Ω–∞–º–∏ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)...")
        
        try:
            result = adapter.process_image(
                test_image, 
                "Extract all text from this image", 
                test_model,
                max_tokens=model_limit
            )
            
            if result and result.get("success"):
                print(f"   ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–∞ –∑–∞ {result.get('processing_time', 0):.2f}—Å")
                print(f"   üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {result.get('tokens_used', 0)}")
                print(f"   üìè –õ–∏–º–∏—Ç –º–æ–¥–µ–ª–∏: {result.get('max_tokens_limit', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
            else:
                print("   ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞")
                return False
                
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
            return False
        
        # –¢–µ—Å—Ç —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ)
        if model_limit < 2048:
            print(f"\n   üß™ –¢–µ—Å—Ç —Å 2048 —Ç–æ–∫–µ–Ω–∞–º–∏ (–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ {model_limit})...")
            
            try:
                result = adapter.process_image(
                    test_image, 
                    "Extract all text from this image", 
                    test_model,
                    max_tokens=2048  # –ü—Ä–µ–≤—ã—à–∞–µ–º –ª–∏–º–∏—Ç
                )
                
                if result and result.get("success"):
                    actual_limit = result.get('max_tokens_limit', model_limit)
                    print(f"   ‚úÖ –ó–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ {actual_limit} —Ç–æ–∫–µ–Ω–æ–≤")
                else:
                    print("   ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞ (–æ–∂–∏–¥–∞–µ–º–æ)")
                    
            except Exception as e:
                print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞: {e} (–æ–∂–∏–¥–∞–µ–º–æ)")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
        return False
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return False

def create_test_report(success: bool):
    """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"""
    
    report = {
        "timestamp": datetime.now().isoformat(),
        "test_name": "vLLM Token Fixes Test",
        "status": "PASSED" if success else "FAILED",
        "fixes_tested": [
            "–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ vLLM API",
            "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏",
            "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥–µ–ª—è—Ö",
            "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"
        ],
        "expected_improvements": [
            "–ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ UI",
            "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö vLLM –º–æ–¥–µ–ª–µ–π",
            "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ –ª–∏–º–∏—Ç–∞ –º–æ–¥–µ–ª–∏",
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        ]
    }
    
    if success:
        report["result"] = "‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        report["recommendations"] = [
            "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é",
            "vLLM —Ä–µ–∂–∏–º —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ª—é–±—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ–∫–µ–Ω–æ–≤",
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —á–µ—Ç–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö"
        ]
    else:
        report["result"] = "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏"
        report["recommendations"] = [
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ vLLM —Å–µ—Ä–≤–µ—Ä—É",
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ vLLM",
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
        ]
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    with open("vllm_token_fixes_test_report.json", "w", encoding="utf-8") as f:
        json.dump(report, f, indent=2, ensure_ascii=False)
    
    return report

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    print("üîß –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô vLLM –¢–û–ö–ï–ù–û–í –ò –ú–û–î–ï–õ–ï–ô")
    print("–î–∞—Ç–∞:", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
    print("=" * 60)
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
    success = test_vllm_adapter_improvements()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    report = create_test_report(success)
    
    print("\n" + "=" * 60)
    print("üìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢")
    print("=" * 60)
    
    print(f"üéØ –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {report['status']}")
    print(f"üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç: {report['result']}")
    
    print("\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")
    for rec in report["recommendations"]:
        print(f"  ‚Ä¢ {rec}")
    
    print(f"\nüìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç: vllm_token_fixes_test_report.json")
    
    if success:
        print("\nüéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ë–û–¢–ê–Æ–¢!")
        print("   ‚Ä¢ –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç—Å—è –ª–∏–º–∏—Ç–æ–º –º–æ–¥–µ–ª–∏")
        print("   ‚Ä¢ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ vLLM")
        print("   ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö")
        print("\n‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–µ–∑ –æ—à–∏–±–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤!")
    else:
        print("\n‚ö†Ô∏è –¢–†–ï–ë–£–Æ–¢–°–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø")
        print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ vLLM –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç")

if __name__ == "__main__":
    main()