# 🏗️ Архитектура ChatVLMLLM

Подробное описание архитектуры проекта и взаимодействия компонентов.

## Общая архитектура

```
┌──────────────────────────────────────────────────┐
│                   UI Слой (Streamlit)                    │
│   ┌──────────────────────────────────────────┐   │
│   │  app.py - точка входа и основной UI │   │
│   │  ui/ - UI компоненты и стили           │   │
│   └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────┐
│                Слой приложения                    │
│   ┌──────────────────────────────────────────┐   │
│   │  vllm_streamlit_adapter.py - vLLM интегр. │   │
│   │  single_container_manager.py - Docker менеджер │   │
│   └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────┐
│             Слой обработки (Utils)               │
│   ┌──────────────────────────────────────────┐   │
│   │  bbox_visualizer.py - BBOX визуализация    │   │
│   │  text_cleaner.py - очистка OCR           │   │
│   │  field_parser.py - парсинг полей          │   │
│   └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────┐
│             Слой моделей (Models)                │
│   ┌──────────────────────────────────────────┐   │
│   │  model_loader.py - загрузка моделей      │   │
│   │  models/<model_name>/ - реализации моделей  │   │
│   └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────┐
│                Основа (PyTorch/HF)                  │
│   ┌──────────────────────────────────────────┐   │
│   │  PyTorch - нейросетевые вычисления     │   │
│   │  Transformers - современные модели      │   │
│   │  vLLM - оптимизированный инференс     │   │
│   └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
```

## Детальное описание слоев

### 1. UI Слой (Streamlit)

Отвечает за взаимодействие с пользователем.

#### Ключевые компоненты:

**app.py**
- Точка входа приложения
- Маршрутизация между режимами (OCR, Чат, Документация)
- Управление session state
- Обработка загрузки файлов

**ui/styles.py**
- CSS стили для Streamlit
- Темы и цветовые схемы
- Кастомные компоненты

**ui/components/**
- `message_renderer.py` - рендеринг сообщений чата
- `sidebar.py` - боковая панель с настройками

### 2. Слой приложения

Бизнес-логика и оркестрация компонентов.

#### vllm_streamlit_adapter.py

```python
class VLLMStreamlitAdapter:
    """
    Адаптер для интеграции vLLM с Streamlit.
    
    Функционал:
    - Обработка изображений через vLLM API
    - Конвертация изображений в base64
    - Управление запросами к API
    - Обработка ошибок и retry
    """
    
    def process_image(self, image, prompt, model, max_tokens):
        """Обработка изображения через vLLM"""
        pass
    
    def get_model_max_tokens(self, model):
        """Получение лимита токенов модели"""
        pass
```

#### single_container_manager.py

```python
class SingleContainerManager:
    """
    Менеджер Docker контейнеров vLLM.
    
    Принцип: один активный контейнер.
    При переключении модели:
    1. Остановка текущего контейнера
    2. Запуск нового контейнера
    3. Ожидание готовности
    """
    
    def start_single_container(self, model_key):
        """Запуск контейнера модели"""
        pass
    
    def get_active_model(self):
        """Получение активной модели"""
        pass
```

### 3. Слой обработки (Utils)

Вспомогательные утилиты для обработки данных.

#### utils/bbox_visualizer.py

```python
class BBoxVisualizer:
    """
    Визуализация BBOX координат на изображениях.
    
    Возможности:
    - Отрисовка bounding boxes
    - Категоризация элементов
    - Создание легенды
    - Парсинг JSON с BBOX данными
    """
    
    def process_dots_ocr_response(self, image, response, show_labels, create_legend_img):
        """Обработка ответа dots.ocr с BBOX"""
        pass
```

#### utils/text_cleaner.py

```python
def clean_ocr_result(text: str) -> str:
    """
    Очистка результата OCR.
    
    - Исправление искаженных символов
    - Удаление повторов
    - Форматирование дат и полей
    - Улучшение структуры
    """
    pass
```

### 4. Слой моделей (Models)

Загрузка и управление VLM моделями.

#### model_loader.py

```python
class ModelLoader:
    """
    Централизованный загрузчик моделей.
    
    Функционал:
    - Динамическая загрузка моделей
    - Кеширование загруженных моделей
    - Управление GPU памятью
    - Квантизация моделей
    """
    
    @staticmethod
    def load_model(model_name: str, precision: str = 'fp16'):
        """Загрузка модели по имени"""
        pass
    
    @staticmethod
    def unload_all_models():
        """Выгрузка всех моделей из памяти"""
        pass
```

## Потоки данных

### OCR Workflow

```
Пользователь
    │
    ↓ Загружает изображение
    │
app.py (UI)
    │
    ↓ Выбирает режим (vLLM/Transformers)
    │
    ├─── vLLM режим ────────────────────────────┐
    │   │                                          │
    │   ↓                                          │
    │ vllm_streamlit_adapter.py                    │
    │   │                                          │
    │   │ Проверяет активный контейнер         │
    │   ↓                                          │
    │ single_container_manager.py                  │
    │   │                                          │
    │   │ Запускает/переключает Docker       │
    │   ↓                                          │
    │ vLLM API (Docker)                            │
    │   │                                          │
    │   │ Обрабатывает изображение            │
    │   ↓                                          │
    │ Возвращает OCR результат                  │
    │   │                                          │
    └───┴──────────────────────────────────────┘
        │
    ┌─── Transformers режим ──────────────────────┐
    │   │                                          │
    │   ↓                                          │
    │ model_loader.py                              │
    │   │                                          │
    │   │ Загружает модель в GPU              │
    │   ↓                                          │
    │ Обрабатывает изображение                  │
    │   │                                          │
    │   ↓                                          │
    │ Возвращает OCR результат                  │
    │   │                                          │
    └───┴──────────────────────────────────────┘
        │
        ↓ Очистка результата
        │
text_cleaner.py
        │
        ↓ BBOX визуализация (если доступна)
        │
bbox_visualizer.py
        │
        ↓ Отображение результатов
        │
app.py (UI)
        │
        ↓
   Пользователь
```

### Чат Workflow

```
Пользователь
    │
    │ Загружает изображение + вводит вопрос
    ↓
app.py (UI)
    │
    │ Сохраняет в session_state.messages
    ↓
    ├─── dots.ocr модель ───────────────────────┐
    │   │                                          │
    │   │ Адаптирует вопрос для OCR          │
    │   ↓                                          │
    │ Возвращает OCR текст + пояснение          │
    │   │                                          │
    └───┴──────────────────────────────────────┘
        │
    ┌─── Универсальная VLM ─────────────────────┐
    │   │                                          │
    │   │ Обрабатывает изображение + вопрос     │
    │   ↓                                          │
    │ Возвращает чат-ответ                       │
    │   │                                          │
    └───┴──────────────────────────────────────┘
        │
        ↓ Рендеринг ответа
        │
render_message_with_json_and_html_tables()
        │
        │ • Конвертация JSON в текстовые таблицы
        │ • BBOX визуализация
        │ • HTML таблицы в текст
        ↓
app.py (UI)
        │
        ↓
   Пользователь
```

## Управление состоянием

### Session State (ключевые переменные)

```python
st.session_state = {
    # Чат
    "messages": [],  # История чата
    
    # Модель
    "current_execution_mode": "vLLM",  # vLLM или Transformers
    "loaded_model": None,  # Текущая модель
    
    # Настройки
    "max_tokens": 4096,
    "temperature": 0.7,
    
    # OCR
    "uploaded_image": None,
    "ocr_result": None,
    "last_ocr_result": None,  # Для BBOX визуализации
    
    # vLLM
    "vllm_adapter": None,
    "single_container_manager": None,
}
```

## Обработка ошибок

### Стратегия обработки

```python
try:
    # vLLM режим
    result = vllm_adapter.process_image(...)
except CUDAError:
    # CUDA ошибки - критичные
    st.error("❌ Ошибка GPU. Перезагрузите страницу")
    st.info("💡 Используйте vLLM режим")
except VLLMConnectionError:
    # vLLM недоступен - fallback на Transformers
    st.warning("⚠️ vLLM недоступен, переключение...")
    model = ModelLoader.load_model(...)
    result = model.process_image(...)
except OutOfMemoryError:
    # GPU память переполнена
    st.error("❌ Out of Memory")
    st.info("💡 Используйте меньшую модель или квантизацию")
```

## Оптимизации

### Производительность

1. **vLLM режим**:
   - PagedAttention для эффективной памяти
   - Continuous batching
   - Оптимизированные CUDA kernels

2. **Один активный контейнер**:
   - Максимальное использование GPU памяти
   - Быстрое переключение между моделями

3. **Кеширование**:
   - Загруженные модели в session_state
   - Hugging Face кеш для весов

### Память

1. **GPU память**:
   - Автоматическая очистка `torch.cuda.empty_cache()`
   - Квантизация (INT8, INT4)
   - Gradient checkpointing

2. **Системная память**:
   - Сборка мусора `gc.collect()`
   - Очистка session_state

## Будущие улучшения

### Планируемые рефакторинги

1. **Разделение app.py**:
   ```
   app.py (100 строк) - точка входа
   ui/
     ├── ocr_page.py - режим OCR
     ├── chat_page.py - режим чата
     └── docs_page.py - документация
   ```

2. **Сервисный слой**:
   ```
   services/
     ├── model_service.py - работа с моделями
     ├── ocr_service.py - OCR логика
     └── chat_service.py - чат логика
   ```

3. **Конфигурация**:
   ```
   config/
     ├── settings.py - централизованные настройки
     └── models.yaml - конфигурация моделей
   ```

## Заключение

Архитектура ChatVLMLLM сочетает:
- **Простоту** - понятные слои и потоки данных
- **Гибкость** - поддержка множества моделей и режимов
- **Производительность** - vLLM и оптимизация GPU
- **Масштабируемость** - модульная структура

Для разработчиков:
- Читайте [CONTRIBUTING.md](../CONTRIBUTING.md)
- Изучайте [models.md](models.md) для понимания моделей
- Проверьте [examples/](../examples/) для примеров использования
