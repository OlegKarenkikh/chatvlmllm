"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —á–∞—Ç–∞ dots.ocr
"""

import sys
import os
from PIL import Image
import json

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏
sys.path.append('.')
sys.path.append('./models')

def test_chat_capabilities():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ dots.ocr"""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ï–ô –ß–ê–¢–ê DOTS.OCR")
    print("=" * 60)
    
    try:
        from models.dots_ocr_final import DotsOCRFinalModel
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        config = {
            'model_name': 'ucaslcl/GOT-OCR2_0',
            'process_xml_tables': False,  # –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —á–∞—Ç–∞
            'extract_structured_fields': False
        }
        
        print("üìù –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏...")
        model = DotsOCRFinalModel(config)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–∞ chat
        if hasattr(model, 'chat'):
            print("‚úÖ –ú–µ—Ç–æ–¥ chat() –¥–æ—Å—Ç—É–ø–µ–Ω")
        else:
            print("‚ùå –ú–µ—Ç–æ–¥ chat() –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return
        
        # –¢–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        test_images = [
            "test_document.png",
            "demo_document.png", 
            "simple_test.png",
            "test_image.png"
        ]
        
        # –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        test_image_path = None
        for img_path in test_images:
            if os.path.exists(img_path):
                test_image_path = img_path
                break
        
        if not test_image_path:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            print("–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É")
            return
        
        print(f"üñºÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {test_image_path}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        try:
            image = Image.open(test_image_path)
            print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {image.size}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return
        
        # –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —á–∞—Ç–∞
        chat_prompts = [
            # –ë–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            "–ß—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ?",
            "–û–ø–∏—à–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
            
            # –í–æ–ø—Ä–æ—Å—ã –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
            "–≠—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç? –ö–∞–∫–æ–≥–æ —Ç–∏–ø–∞?",
            "–ï—Å—Ç—å –ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —Ç–∞–±–ª–∏—Ü—ã?",
            "–ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ?",
            "–°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ?",
            
            # –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            "–ù–∞–π–¥–∏ –≤—Å–µ —á–∏—Å–ª–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ",
            "–ï—Å—Ç—å –ª–∏ –¥–∞—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ?",
            "–ö–∞–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞?",
            "–ù–∞–π–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
            
            # –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            "–û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞",
            "–°–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤ –≤ —Ç–µ–∫—Å—Ç–µ?",
            "–ï—Å—Ç—å –ª–∏ —Å–ø–∏—Å–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è?",
            
            # –Ø–∑—ã–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
            "–ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –Ω–∞–ø–∏—Å–∞–Ω —Ç–µ–∫—Å—Ç?",
            "–ü–µ—Ä–µ–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
            
            # –í–∏–∑—É–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            "–ö–∞–∫–∏–µ —Ü–≤–µ—Ç–∞ –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—Ç?",
            "–ï—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏?",
            "–ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞ —Ö–æ—Ä–æ—à–µ–µ –∏–ª–∏ –ø–ª–æ—Ö–æ–µ?"
        ]
        
        print(f"\nüó£Ô∏è –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï {len(chat_prompts)} –ü–†–û–ú–ü–¢–û–í")
        print("=" * 60)
        
        successful_chats = 0
        failed_chats = 0
        
        for i, prompt in enumerate(chat_prompts, 1):
            print(f"\n{i:2d}. ü§î –í–æ–ø—Ä–æ—Å: {prompt}")
            print("-" * 50)
            
            try:
                # –ü—Ä–æ–±—É–µ–º –º–µ—Ç–æ–¥ chat
                result = model.chat(image, prompt)
                
                if result and len(result.strip()) > 0:
                    print(f"‚úÖ –û—Ç–≤–µ—Ç: {result[:200]}{'...' if len(result) > 200 else ''}")
                    successful_chats += 1
                else:
                    print("‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                    failed_chats += 1
                    
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                failed_chats += 1
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print(f"\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
        print("=" * 60)
        print(f"–£—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {successful_chats}")
        print(f"–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: {failed_chats}")
        print(f"–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: {successful_chats/(successful_chats+failed_chats)*100:.1f}%")
        
        # –¢–µ—Å—Ç –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        print(f"\nüîÑ –¢–ï–°–¢ –ú–ù–û–ì–û–®–ê–ì–û–í–û–ì–û –î–ò–ê–õ–û–ì–ê")
        print("=" * 60)
        
        dialog_prompts = [
            "–ß—Ç–æ —ç—Ç–æ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç?",
            "–ê –∫–∞–∫–∞—è –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –Ω–µ–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è?", 
            "–ï—Å—Ç—å –ª–∏ –≤ –Ω–µ–º —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ?",
            "–ú–æ–∂–µ—à—å –≤—ã–¥–µ–ª–∏—Ç—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ?"
        ]
        
        for i, prompt in enumerate(dialog_prompts, 1):
            print(f"\n–®–∞–≥ {i}: {prompt}")
            try:
                result = model.chat(image, prompt)
                print(f"–û—Ç–≤–µ—Ç: {result[:150]}{'...' if len(result) > 150 else ''}")
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞: {e}")
        
        print(f"\nüéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï")
        print("=" * 60)
        if successful_chats > failed_chats:
            print("‚úÖ dots.ocr –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢ —Ä–µ–∂–∏–º —á–∞—Ç–∞!")
            print("–ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö")
        else:
            print("‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã")
            print("–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã")
            
    except ImportError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª—å dots.ocr –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
    except Exception as e:
        print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()


def test_predefined_prompts():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã"""
    
    print("\nüìã –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–ï–î–£–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–• –ü–†–û–ú–ü–¢–û–í")
    print("=" * 60)
    
    try:
        from dots_ocr.utils.prompts import dict_promptmode_to_prompt
        
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã:")
        for i, (mode, prompt) in enumerate(dict_promptmode_to_prompt.items(), 1):
            print(f"\n{i}. {mode}:")
            print(f"   {prompt[:100]}{'...' if len(prompt) > 100 else ''}")
        
        print(f"\n‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(dict_promptmode_to_prompt)} –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤")
        
    except ImportError:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã dots.ocr")


def demonstrate_usage():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    
    print("\nüí° –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ß–ê–¢–ê")
    print("=" * 60)
    
    examples = [
        {
            "task": "–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
            "code": '''
# –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑
result = model.chat(image, "–ß—Ç–æ —ç—Ç–æ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∫–∞–∫–∞—è –≤ –Ω–µ–º –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è?")

# –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
result = model.chat(image, "–ù–∞–π–¥–∏ –≤—Å–µ –¥–∞—Ç—ã –∏ —Å—É–º–º—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ")

# –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
result = model.chat(image, "–û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ä–∞–∑–¥–µ–ª—ã, —Ç–∞–±–ª–∏—Ü—ã")
'''
        },
        {
            "task": "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "code": '''
# –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
result = model.chat(image, "–ù–∞–π–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: —Ç–µ–ª–µ—Ñ–æ–Ω—ã, email, –∞–¥—Ä–µ—Å–∞")

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
result = model.chat(image, "–ö–∞–∫–∏–µ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —á–∏—Å–ª–∞ –∏ —Ñ–∞–∫—Ç—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ?")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
result = model.chat(image, "–ï—Å—Ç—å –ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è?")
'''
        },
        {
            "task": "–Ø–∑—ã–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏",
            "code": '''
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
result = model.chat(image, "–ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –Ω–∞–ø–∏—Å–∞–Ω —Ç–µ–∫—Å—Ç?")

# –ü–µ—Ä–µ–≤–æ–¥
result = model.chat(image, "–ü–µ—Ä–µ–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫")

# –†–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ
result = model.chat(image, "–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö")
'''
        }
    ]
    
    for example in examples:
        print(f"\nüéØ {example['task']}:")
        print(example['code'])


if __name__ == "__main__":
    test_predefined_prompts()
    test_chat_capabilities() 
    demonstrate_usage()
    
    print(f"\nüöÄ –ì–û–¢–û–í–û!")
    print("–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª—å—é dots.ocr")